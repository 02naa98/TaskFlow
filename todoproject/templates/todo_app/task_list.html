{% extends 'base.html' %}  <!-- base.html を継承 -->
{% load static %}

<title>{% block title %}TaskList{% endblock %}</title>  <!-- タイトルを上書き -->

{% block content %}
<div class='container'>
    <!-- 左側：リスト名とチェックボックス -->
    <div class='list-filter'>
        <!-- 新しいリスト作成へのリンク -->
        <a class="list-create" href="{% url 'list_create' %}">新しいリストを作成する</a>
        
        <!-- タスクリストの見出し -->
        <h1>タスクリスト</h1>
        
        <!-- リストフォーム(仮)へのリンク -->
        <a href="{% url 'select_list' %}"><h5>リストフォーム(仮)</h5></a>

        <!-- チェックボックス付きリスト選択フォーム -->
        <form method="post" action="{% url 'task_list' %}">
            {% csrf_token %}
            <ul>
                {% for list in lists %}
                    <!-- リスト項目 -->
                    <li style="display: flex; align-items: center; justify-content: space-between;">
                        <!-- チェックボックス -->
                        <input type="checkbox" class="list-checkbox" id="checkbox_{{ list.id }}" value="{{ list.id }}">
                        <label for="checkbox_{{ list.id }}">
                            {{ list.name }}
                        </label>
                        <div class="btn-group">
                            <!-- リスト編集ボタン（未実装） -->
                            <!-- リスト削除ボタン ポップアップ＆ダイアログ（未実装） -->
                        </div>
                    </li>
                {% endfor %}
            </ul>
            <div class="btn-group">
                <!-- リスト選択ボタン -->
                <button type="submit" class="button">選択したリストを表示</button>
            </div>
        </form>
        
        <!-- カレンダーへのリンク -->
        <a href="{% url 'only_calendar' %}">カレンダー</a>
    </div>

    <!-- ２列目：タスク一覧 -->
    <div class='task-list'>
        <!-- タスク作成リンク -->
        <a class="task-create" href="{% url 'task_create' %}">タスクを作成する</a>
        
        <!-- タスクフィルタリングフォーム -->
        <form method="get">
            <label for="filter_name" class="filter-label">名前でフィルタリング:</label>
            <input type="text" name="filter_name" id="filter_name" placeholder="名前を入力">
            <button type="submit">検索</button>
        </form>
        
        <h1>タスク一覧</h1>
        
        {% if lists %}
            {% for list in lists %}
                <div class="list-container" onmouseover="showBorder(this)" onmouseout="hideBorder(this)">
                    <!-- リスト名 -->
                    <h2>{{ list.name }}</h2>

                    <div class="btn-group">
                        <!-- リスト更新フォーム -->
                        <form action="{% url 'list_update' list.id %}">
                            {% csrf_token %}
                            <button type="submit" class="button">更新</button>
                        </form>

                        <!-- リスト削除フォーム -->
                        <form action="{% url 'list_delete' list.id %}" method="post" onsubmit="return confirmDeleteList();">
                            {% csrf_token %}
                            <button type="submit" class="button">削除</button>
                        </form>
                    </div>

                    <!-- タスクリスト（Sortable） -->
                    <ul class="Sortable" data-list-id="{{list.id}}" id="list_{{list.id}}">
                        {% for task in list.taskcreate_set.all %}
                            <li style="display: flex; align-items: center; justify-content: space-between;">
                                <!-- タスク項目 -->
                                <span>
                                    {{ task.title }} - {{ task.due_date }} - {{ task.user.username }}
                                </span>

                                <!-- タスクのスター付けフォーム -->
                                <form action="{% url 'toggle_star' task.id %}" method="post" style="background: none; border: none; cursor: none;">
                                    {% csrf_token %}
                                    <div class='btn-group'>
                                        <button type="submit">
                                            <span class="{% if task.is_starred %}starred{% else %}not-starred{% endif %}">
                                                {% if task.is_starred %}
                                                    ★  <!-- スターが付いている場合 -->
                                                {% else %}
                                                    ☆  <!-- スターが付いていない場合 -->
                                                {% endif %}
                                            </span>
                                        </button>
                                    </div>
                                </form>

                                <div>
                                    <!-- タスク更新ボタン -->
                                    <form action="{% url 'task_update' list.id %}" method="get">
                                        <button type="submit" class="btn btn-success">更新</button>
                                    </form>
                                    <!-- タスク削除ボタン -->
                                    <form action="{% url 'task_delete' task.id %}" method="post" onsubmit="return confirmDeleteTask();" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-danger">削除</button>
                                    </form>
                                </div>
                            </li>
                        {% empty %}
                            <li>タスクはまだ追加されていません。</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endfor %}
        {% elif message %}
            <script>
                // メッセージが存在する場合にアラートを表示
                alert('{{ message }}')
                alert('もう一度検索ボタンをクリックすると一覧表示へ戻ります。')
            </script>
        {% endif %}
        
        <script>
            // タスク削除確認
            function confirmDeleteTask() {
                return confirm("本当に削除しますか？");
            }
            
            // リスト削除確認
            function confirmDeleteList() {
                return confirm("このリストを削除しますか？ このリスト上のすべてのタスクが完全に削除されます。");
            }

            // マウスオーバー時にボーダーを表示
            function showBorder(element) {
                const allContainers = document.querySelectorAll('.list-container','.Sortable');
                allContainers.forEach(container => {
                    container.style.border = 'none'; // すべてのボーダーを削除
                });

                // 選択された要素にボーダーを追加
                element.style.boxShadow = "0 2px 5px rgba(0, 123, 255, 0.5)"; // 青色の影を追加
            }

            // マウスアウト時にボーダーを非表示
            function hideBorder(element) {
                element.style.border = "none"; // 元の枠線の色
                element.style.boxShadow = 'none'; // 影を削除
            }

            // セッションストレージからメッセージを取得
            const message = sessionStorage.getItem('message');

            // メッセージが存在する場合、アラートを表示
            if (message) {
                alert(message);
                sessionStorage.removeItem('message'); // メッセージを表示後に削除
            }
        </script>
    </div>

    <!-- 右側：スター付きタスクのみを表示 -->
    <div class="star-list">
        <h1>★スター付き</h1>
        <ul>
            {% for task in tasks %}
                {% if task.is_starred %}
                    <li>
                        {{ task.title }} - {{ task.user.username }} - {{ task.list.name }}
                    </li>
                {% endif %}
            {% empty %}
                <li>スター付きタスクはありません。</li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endblock %}

